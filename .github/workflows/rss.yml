name: RSS → Repo (Substack sync)

on:
  schedule:
    # Align with 10:22 posts but give buffer → :25
    - cron: "25 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: finch-rss-sync
  cancel-in-progress: true

jobs:
  import:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      SUBSTACK_RSS_URL:   ${{ secrets.SUBSTACK_RSS_URL }}
      RSS_PROXY_URL:      ${{ secrets.RSS_PROXY_URL }}
      IMPORT_LATEST_ONLY: "1"
      IMPORT_DEBUG:       "0"
      GIT_USER_NAME:      "HallowayFinch"
      GIT_USER_EMAIL:     ${{ secrets.HF_NOREPLY_EMAIL }}
      FALLBACK_EMAIL:     ${{ github.actor }}@users.noreply.github.com
      HF_PAT:             ${{ secrets.HF_PAT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "scripts/requirements.txt"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Import RSS → _logs + ensure /artifacts/{slug}/
        run: |
          set -euo pipefail
          python scripts/rss_to_repo.py

      - name: Hash artifacts (metadata.json)
        run: |
          set -euo pipefail
          python scripts/hash_artifacts.py || true

      - name: Validate site
        run: |
          set -euo pipefail
          python scripts/validate_site.py || true

      - id: commit
        name: Commit (if changes)
        run: |
          set -euo pipefail
          EMAIL="${GIT_USER_EMAIL:-}"
          if [ -z "$EMAIL" ]; then EMAIL="$FALLBACK_EMAIL"; fi
          git config user.name  "${GIT_USER_NAME}"
          git config user.email "${EMAIL}"
          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to commit."
          else
            git commit -m "chore(import): RSS, hash artifacts, validate site"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Safe push (rebase + retry) with PAT
        if: steps.commit.outputs.changed == 'true'
        run: |
          set -euo pipefail
          git fetch origin main
          for n in 1 2 3; do
            git pull --rebase origin main || true
            if git push "https://x-access-token:${HF_PAT}@github.com/${{ github.repository }}.git" HEAD:main; then
              exit 0
            fi
            echo "Push attempt $n failed; retrying..."
            sleep 2
          done
          echo "Push failed after retries" >&2
          exit 1