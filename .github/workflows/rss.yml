name: RSS → Repo (Substack sync)

on:
  schedule:
    - cron: "22 * * * *"   # every hour at :22 past
  workflow_dispatch: {}     # manual run button

# (Not strictly needed when pushing with PAT, but harmless to keep.)
permissions:
  contents: write

concurrency:
  group: finch-rss-sync
  cancel-in-progress: true

jobs:
  import:
    runs-on: ubuntu-latest
    env:
      SUBSTACK_RSS_URL:     ${{ secrets.SUBSTACK_RSS_URL }}
      RSS_PROXY_URL:        ${{ secrets.RSS_PROXY_URL }}
      IMPORT_LATEST_ONLY:   "1"
      IMPORT_DEBUG:         "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false   # don't write GITHUB_TOKEN to origin

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install feedparser

      - name: Import RSS → _logs + ensure /artifacts/{slug}/
        run: |
          set -euo pipefail
          python scripts/rss_to_repo.py

      - name: Hash artifacts (metadata.json)
        run: |
          python scripts/hash_artifacts.py || true

      - name: Validate site
        run: |
          python scripts/validate_site.py || true

      - name: Commit (if changes)
        id: commit
        run: |
          git config user.name  "HallowayFinch"
          git config user.email "${{ secrets.HF_NOREPLY_EMAIL }}"

          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to commit."
          else
            git commit -m "chore: import RSS, hash artifacts, validate site"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push (if committed) with PAT
        if: steps.commit.outputs.changed == 'true'
        run: |
          git push "https://x-access-token:${{ secrets.HF_PAT }}@github.com/${{ github.repository }}.git" HEAD:main
