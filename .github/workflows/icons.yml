name: Build Icons

on:
  push:
    paths:
      - "assets/icons/finch.svg"
      - "assets/icons/safari-pinned-tab.svg"
      - ".github/workflows/icons.yml"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: finch-icons
  cancel-in-progress: true

jobs:
  build-icons:
    runs-on: ubuntu-latest
    env:
      GIT_AUTHOR_NAME:  "HallowayFinch"
      GIT_AUTHOR_EMAIL: ${{ secrets.HF_NOREPLY_EMAIL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install rasterizers (librsvg + ImageMagick 6)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y librsvg2-bin imagemagick
          rsvg-convert --version
          convert -version

      - name: Generate PNGs + ICO from SVG
        working-directory: assets/icons
        env:
          SRC: finch.svg
        run: |
          set -euo pipefail
          SIZES=(16 32 48 180 192 256 384 512)
          for S in "${SIZES[@]}"; do
            rsvg-convert -w "$S" -h "$S" "$SRC" -o "favicon-${S}.png"
          done
          cp favicon-180.png apple-touch-icon.png
          cp favicon-192.png android-chrome-192x192.png
          cp favicon-512.png android-chrome-512x512.png
          convert favicon-16.png favicon-32.png favicon-48.png favicon.ico

      - name: Write site.webmanifest
        run: |
          set -euo pipefail
          cat > site.webmanifest <<'JSON'
          {
            "name": "Finch Archive",
            "short_name": "Finch",
            "start_url": "/",
            "display": "minimal-ui",
            "background_color": "#000000",
            "theme_color": "#000000",
            "icons": [
              { "src": "/assets/icons/android-chrome-192x192.png", "sizes": "192x192", "type": "image/png", "purpose": "any" },
              { "src": "/assets/icons/android-chrome-512x512.png", "sizes": "512x512", "type": "image/png", "purpose": "any" }
            ]
          }
          JSON

      - name: Ensure root favicon.ico (legacy/edge cases)
        run: |
          set -euo pipefail
          cp -f assets/icons/favicon.ico ./favicon.ico

      - name: Commit & push generated icons/manifest
        run: |
          set -euo pipefail
          git config user.name  "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git add \
            assets/icons/apple-touch-icon.png \
            assets/icons/android-chrome-192x192.png \
            assets/icons/android-chrome-512x512.png \
            assets/icons/favicon-16.png \
            assets/icons/favicon-32.png \
            assets/icons/favicon-48.png \
            assets/icons/favicon-180.png \
            assets/icons/favicon-192.png \
            assets/icons/favicon-256.png \
            assets/icons/favicon-384.png \
            assets/icons/favicon-512.png \
            assets/icons/favicon.ico \
            site.webmanifest \
            favicon.ico || true
          if git diff --cached --quiet; then
            echo "No icon/manifest changes to commit."
            exit 0
          fi
          git commit -m "chore(icons): regenerate favicons & webmanifest from finch.svg"
          git push "https://x-access-token:${{ secrets.HF_PAT }}@github.com/${{ github.repository }}.git" HEAD:main