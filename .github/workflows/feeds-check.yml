name: Feeds Check & Publish

on:
  # run manually when you want, and also hourly at :21
  workflow_dispatch: {}
  schedule:
    - cron: "21 * * * *"

permissions:
  contents: write

concurrency:
  group: finch-feeds-check
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      # Optional: proxy that accepts ?url=<encoded>
      RSS_PROXY_URL: ${{ secrets.RSS_PROXY_URL }}
      GIT_USER_NAME:  "HallowayFinch"
      GIT_USER_EMAIL: ${{ secrets.HF_NOREPLY_EMAIL }}
      HF_PAT:         ${{ secrets.HF_PAT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Probe feeds & write status/feeds.json
        id: probe
        shell: bash
        run: |
          set -euo pipefail

          ua="FinchArchiveFeedCheck/1.0 (+https://fincharchive.com/status/)"
          accept="application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.8"

          probe() {
            local url="$1"
            local target="$url"

            # If a proxy is configured, route the check through it
            if [ -n "${RSS_PROXY_URL:-}" ]; then
              enc="$(printf '%s' "$url" | jq -s -R -r @uri)"
              target="${RSS_PROXY_URL}?url=${enc}"
            fi

            code="$(curl -sS -L \
              -H "User-Agent: ${ua}" \
              -H "Accept: ${accept}" \
              -H "Referer: https://fincharchive.com/status/" \
              --retry 2 --retry-delay 1 --max-time 20 \
              -o /dev/null -w "%{http_code}" \
              "$target" || echo 000)"

            printf '%s' "$code"
          }

          updated="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          all_rss="https://fincharchive.com/feed/"
          all_json="https://fincharchive.com/feed.json"
          logs_rss="https://fincharchive.com/logs/feed.xml"
          fn_rss="https://fincharchive.com/field-notes/feed.xml"
          substack_fn="https://substack.com/api/v1/notes/rss?publication_id=6660929"

          all_rss_code="$(probe "$all_rss")"
          all_json_code="$(probe "$all_json")"
          logs_rss_code="$(probe "$logs_rss")"
          fn_rss_code="$(probe "$fn_rss")"
          substack_fn_code="$(probe "$substack_fn")"

          mkdir -p status
          cat > status/feeds.json <<JSON
          {
            "updated_utc": "${updated}",
            "endpoints": [
              { "name": "ALL (RSS)",                 "url": "${all_rss}",     "status": ${all_rss_code} },
              { "name": "ALL (JSON)",                "url": "${all_json}",    "status": ${all_json_code} },
              { "name": "Logs (RSS)",                "url": "${logs_rss}",    "status": ${logs_rss_code} },
              { "name": "Field Notes (RSS)",         "url": "${fn_rss}",      "status": ${fn_rss_code} },
              { "name": "Substack Field Notes (external)", "url": "${substack_fn}", "status": ${substack_fn_code} }
            ]
          }
          JSON

      - name: Commit feeds.json (if changed)
        id: commit
        run: |
          set -euo pipefail
          git config user.name  "${GIT_USER_NAME}"
          git config user.email "${GIT_USER_EMAIL:-${{ github.actor }}@users.noreply.github.com}"
          git add status/feeds.json
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No change in status/feeds.json"
          else
            git commit -m "chore(status): refresh feeds.json"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push (if committed) with PAT
        if: steps.commit.outputs.changed == 'true'
        run: |
          git push "https://x-access-token:${HF_PAT}@github.com/${{ github.repository }}.git" HEAD:main
