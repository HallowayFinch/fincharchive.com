name: Feeds Check & Publish

on:
  schedule:
    - cron: "12 * * * *" # check hourly (staggered from RSS import)
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Probe feeds and write status/feeds.json
        shell: bash
        run: |
          set -euo pipefail

          # Probe via the canonical GitHub Pages host to avoid Cloudflare 403s
          BASE_GH="https://hallowayfinch.github.io/fincharchive.com"

          probe() {
            local url="$1"
            curl -sS -L -o /dev/null \
              -A "FinchStatus/1.0 (+https://fincharchive.com/status/)" \
              -H "Accept: application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.8" \
              -w "%{http_code}" "$url" || true
          }

          updated="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          all_rss_code="$(probe  "$BASE_GH/feed/")"
          all_json_code="$(probe "$BASE_GH/feed.json")"
          logs_rss_code="$(probe "$BASE_GH/logs/feed.xml")"
          fn_rss_code="$(probe   "$BASE_GH/field-notes/feed.xml")"
          substack_fn_code="$(probe "https://substack.com/api/v1/notes/rss?publication_id=6660929")"

          mkdir -p status
          cat > status/feeds.json <<JSON
          {
            "updated_utc": "${updated}",
            "endpoints": [
              { "name": "ALL (RSS)",   "url": "https://fincharchive.com/feed/",                 "status": ${all_rss_code} },
              { "name": "ALL (JSON)",  "url": "https://fincharchive.com/feed.json",             "status": ${all_json_code} },
              { "name": "Logs (RSS)",  "url": "https://fincharchive.com/logs/feed.xml",         "status": ${logs_rss_code} },
              { "name": "Field Notes (RSS)", "url": "https://fincharchive.com/field-notes/feed.xml", "status": ${fn_rss_code} },
              { "name": "Substack Field Notes (external)", "url": "https://substack.com/api/v1/notes/rss?publication_id=6660929", "status": ${substack_fn_code} }
            ]
          }
          JSON

      - name: Commit & push feeds.json (HallowayFinch)
        env:
          HF_PAT: ${{ secrets.HF_PAT }}
          HF_EMAIL: ${{ secrets.HF_NOREPLY_EMAIL }}
        run: |
          set -euo pipefail
          git config user.name  "HallowayFinch"
          git config user.email "${HF_EMAIL:-${GITHUB_ACTOR}@users.noreply.github.com}"
          git add status/feeds.json
          if git diff --cached --quiet; then
            echo "No change in status/feeds.json"
            exit 0
          fi
          git commit -m "chore(status): refresh feeds.json"
          git push "https://x-access-token:${HF_PAT}@github.com/${GITHUB_REPOSITORY}.git" HEAD:main
