name: Feeds Check & Publish

on:
  workflow_dispatch: {}
  schedule:
    # run at :12 past each hour
    - cron: "12 * * * *"

permissions:
  contents: write

concurrency:
  group: finch-feeds-check
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      SITE_BASE: "https://fincharchive.com"
      RSS_PROXY_URL: ${{ secrets.RSS_PROXY_URL }}
      UA: "FinchFeedsCheck (GitHub Actions; +https://fincharchive.com/status/)"
      GIT_AUTHOR_NAME: "HallowayFinch"
      GIT_AUTHOR_EMAIL: ${{ secrets.HF_NOREPLY_EMAIL }}

    steps:
      - name: Checkout (keep credentials; use GITHUB_TOKEN to push)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure jq present
        shell: bash
        run: |
          set -euo pipefail
          command -v jq >/dev/null || { sudo apt-get update -y && sudo apt-get install -y jq; }

      - name: Probe feeds and write /status/feeds.json (no heredocs)
        shell: bash
        run: |
          set -euo pipefail

          url_encode () {
            python3 -c "import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1],safe=''))" "$1"
          }

          probe () {
            local url="$1"
            local http_code via="origin"

            http_code="$(curl -sS -L \
              -A "$UA" \
              -H "Accept: application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.1" \
              --max-time 20 --retry 2 --retry-delay 1 \
              -o /dev/null -w "%{http_code}" "$url" || true)"

            if [[ ( "$http_code" == "403" || "$http_code" == "000" ) && -n "${RSS_PROXY_URL:-}" ]]; then
              enc="$(url_encode "$url")"
              prox="${RSS_PROXY_URL}?url=${enc}"
              pcode="$(curl -sS -L \
                -A "$UA" \
                -H "Accept: application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.1" \
                --max-time 20 --retry 2 --retry-delay 1 \
                -o /dev/null -w "%{http_code}" "$prox" || true)"
              if [[ "$pcode" =~ ^[0-9]{3}$ && "$pcode" != "000" ]]; then
                http_code="$pcode"; via="proxy"
              fi
            fi

            printf '%s\t%s\n' "$http_code" "$via"
          }

          ALL_RSS="${SITE_BASE}/feed/"
          ALL_JSON="${SITE_BASE}/feed.json"
          LOGS_RSS="${SITE_BASE}/logs/feed.xml"
          NOTES_RSS="${SITE_BASE}/field-notes/feed.xml"
          SUBSTACK_FN="https://substack.com/api/v1/notes/rss?publication_id=6660929"

          tmp="$(mktemp)"
          add_item () {
            local name="$1" url="$2"
            read -r code via < <(probe "$url")
            jq -n --arg n "$name" --arg u "$url" --argjson s "${code:-0}" '{name:$n,url:$u,status:$s}' >> "$tmp"
          }

          add_item "ALL (RSS)"               "$ALL_RSS"
          add_item "ALL (JSON)"              "$ALL_JSON"
          add_item "Logs (RSS)"              "$LOGS_RSS"
          add_item "Field Notes (RSS)"       "$NOTES_RSS"
          add_item "Substack Field Notes"    "$SUBSTACK_FN"

          updated="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          mkdir -p status
          jq -n --arg u "$updated" --slurpfile e "$tmp" '{updated_utc:$u, endpoints:$e}' > status/feeds.json
          rm -f "$tmp"

      - name: Commit & push feeds.json
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git add status/feeds.json
          if git diff --cached --quiet; then
            echo "No change in status/feeds.json"
          else
            git commit -m "chore(status): refresh feeds.json"
            git push
          fi