name: Feeds Check & Publish

on:
  workflow_dispatch: {}
  schedule:
    - cron: "12 * * * *"   # every hour at :12

permissions:
  contents: write

concurrency:
  group: finch-feeds-check
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      SITE_BASE: "https://fincharchive.com"
      RSS_PROXY_URL: ${{ secrets.RSS_PROXY_URL }}
      UA: "FinchFeedsCheck (GitHub Actions; +https://fincharchive.com/status/)"
    steps:
      - name: Checkout (keep credentials)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Probe feeds and write /status/feeds.json
        shell: bash
        run: |
          set -euo pipefail

          url_encode () {
            python3 - "$1" <<'PY'
import urllib.parse, sys
print(urllib.parse.quote(sys.argv[1], safe=""))
PY
          }

          probe () {
            local url="$1"
            local http_code via="origin"

            http_code="$(curl -sS -L \
              -A "$UA" \
              -H "Accept: application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.1" \
              --max-time 20 --retry 2 --retry-delay 1 \
              -o /dev/null -w "%{http_code}" "$url" || true)"

            if [[ ( "$http_code" == "403" || "$http_code" == "000" ) && -n "${RSS_PROXY_URL:-}" ]]; then
              enc="$(url_encode "$url")"
              prox="${RSS_PROXY_URL}?url=${enc}"
              pcode="$(curl -sS -L \
                -A "$UA" \
                -H "Accept: application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.1" \
                --max-time 20 --retry 2 --retry-delay 1 \
                -o /dev/null -w "%{http_code}" "$prox" || true)"
              if [[ "$pcode" =~ ^[0-9]{3}$ && "$pcode" != "000" ]]; then
                http_code="$pcode"; via="proxy"
              fi
            fi

            printf '%s\t%s\n' "$http_code" "$via"
          }

          ALL_RSS="${SITE_BASE}/feed/"
          ALL_JSON="${SITE_BASE}/feed.json"
          LOGS_RSS="${SITE_BASE}/logs/feed.xml"
          NOTES_RSS="${SITE_BASE}/field-notes/feed.xml"
          SUBSTACK_FN="https://substack.com/api/v1/notes/rss?publication_id=6660929"

          declare -A MAP
          while read -r name url; do
            read -r code via < <(probe "$url")
            MAP["$name|url"]="$url"
            MAP["$name|status"]="$code"
            MAP["$name|via"]="$via"
          done <<EOF
ALL (RSS)        $ALL_RSS
ALL (JSON)       $ALL_JSON
Logs (RSS)       $LOGS_RSS
Field Notes (RSS) $NOTES_RSS
Substack Field Notes (external) $SUBSTACK_FN
EOF

          updated="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          mkdir -p status

          cat > status/feeds.json <<'JSON'
          {
            "updated_utc": "__UPDATED__",
            "endpoints": [
              { "name": "ALL (RSS)", "url": "__ALL_RSS__", "status": __ALL_RSS_STATUS__ },
              { "name": "ALL (JSON)", "url": "__ALL_JSON__", "status": __ALL_JSON_STATUS__ },
              { "name": "Logs (RSS)", "url": "__LOGS_RSS__", "status": __LOGS_RSS_STATUS__ },
              { "name": "Field Notes (RSS)", "url": "__NOTES_RSS__", "status": __NOTES_RSS_STATUS__ },
              { "name": "Substack Field Notes (external)", "url": "__SUBSTACK_FN__", "status": __SUBSTACK_FN_STATUS__ }
            ]
          }
JSON

          sed -i \
            -e "s|__UPDATED__|${updated}|g" \
            -e "s|__ALL_RSS__|${MAP["ALL (RSS)|url"]}|g" \
            -e "s|__ALL_JSON__|${MAP["ALL (JSON)|url"]}|g" \
            -e "s|__LOGS_RSS__|${MAP["Logs (RSS)|url"]}|g" \
            -e "s|__NOTES_RSS__|${MAP["Field Notes (RSS)|url"]}|g" \
            -e "s|__SUBSTACK_FN__|${MAP["Substack Field Notes (external)|url"]}|g" \
            -e "s|__ALL_RSS_STATUS__|${MAP["ALL (RSS)|status"]}|g" \
            -e "s|__ALL_JSON_STATUS__|${MAP["ALL (JSON)|status"]}|g" \
            -e "s|__LOGS_RSS_STATUS__|${MAP["Logs (RSS)|status"]}|g" \
            -e "s|__NOTES_RSS_STATUS__|${MAP["Field Notes (RSS)|status"]}|g" \
            -e "s|__SUBSTACK_FN_STATUS__|${MAP["Substack Field Notes (external)|status"]}|g" \
            status/feeds.json

      - name: Commit & push feeds.json (GITHUB_TOKEN)
        env:
          GIT_AUTHOR_NAME:  HallowayFinch
          GIT_AUTHOR_EMAIL: ${{ github.actor }}@users.noreply.github.com
          GIT_COMMITTER_NAME:  HallowayFinch
          GIT_COMMITTER_EMAIL: ${{ github.actor }}@users.noreply.github.com
        run: |
          set -e
          git add status/feeds.json
          if git diff --cached --quiet; then
            echo "No change in status/feeds.json"
          else
            git commit -m "chore(status): refresh feeds.json"
            git push
          fi
