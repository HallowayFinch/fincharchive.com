name: Feeds Check & Publish

on:
  schedule:
    - cron: "19 * * * *"   # hourly, offset from other jobs
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: finch-feeds-check
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      SITE_BASE: "https://fincharchive.com"
      RSS_PROXY_URL: ${{ secrets.RSS_PROXY_URL }}   # optional, used only on 403/000
      GIT_USER_NAME: "HallowayFinch"
      GIT_USER_EMAIL: ${{ secrets.HF_NOREPLY_EMAIL }}
      HF_PAT: ${{ secrets.HF_PAT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Probe feeds and write /status/feeds.json
        id: probe
        shell: bash
        run: |
          set -euo pipefail

          ua="FinchFeedsCheck/1.0 (+https://fincharchive.com/status/)"
          accept="application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.8"

          # curl that returns an HTTP code or 000 on failure
          hit () {
            local url="$1"
            curl -sS -L \
              -A "$ua" \
              -H "Accept: $accept" \
              --max-time 20 --retry 2 --retry-delay 1 \
              -o /dev/null -w "%{http_code}" \
              "$url" || echo "000"
          }

          # try URL, and if blocked (403/000) optionally retry via RSS proxy
          check () {
            local name="$1" url="$2"
            local code via="origin"
            code="$(hit "$url")"
            if [[ ("$code" = "403" || "$code" = "000") && -n "${RSS_PROXY_URL:-}" ]]; then
              # proxy expects ?url=<encoded>
              enc="$(python - <<PY
import urllib.parse, sys
print(urllib.parse.quote(sys.argv[1], safe=""))
PY
"${url}")"
              purl="${RSS_PROXY_URL}?url=${enc}"
              pcode="$(hit "$purl")"
              if [[ "$pcode" =~ ^[0-9]{3}$ && "$pcode" != "000" ]]; then
                code="$pcode"; via="proxy"
              fi
            fi
            printf '%s|%s|%s\n' "$name" "$url" "$code" >> /tmp/FEED_RESULTS
            printf '%s=%s\n' "${name// /_}_VIA" "$via" >> /tmp/FEED_VIA.env
          }

          ALL_RSS="${SITE_BASE}/feed/"
          ALL_JSON="${SITE_BASE}/feed.json"
          LOGS_RSS="${SITE_BASE}/logs/feed.xml"
          NOTES_RSS="${SITE_BASE}/field-notes/feed.xml"
          SUBSTACK_FN="https://substack.com/api/v1/notes/rss?publication_id=6660929"

          : > /tmp/FEED_RESULTS
          : > /tmp/FEED_VIA.env

          check "ALL (RSS)" "$ALL_RSS"
          check "ALL (JSON)" "$ALL_JSON"
          check "Logs (RSS)" "$LOGS_RSS"
          check "Field Notes (RSS)" "$NOTES_RSS"
          check "Substack Field Notes (external)" "$SUBSTACK_FN"

          # shellcheck disable=SC1091
          source /tmp/FEED_VIA.env || true

          updated_utc="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          mkdir -p status

          # Build JSON from results
          {
            echo '{'
            echo "  \"updated_utc\": \"${updated_utc}\","
            echo '  "endpoints": ['
            i=0; total=$(wc -l < /tmp/FEED_RESULTS)
            while IFS='|' read -r name url code; do
              i=$((i+1))
              key="${name// /_}"
              via_var="${key}_VIA"
              via="${!via_var:-origin}"
              printf '    { "name": %s, "url": %s, "status": %s, "via": %s }%s\n' \
                "$(jq -Rn --arg s "$name" '$s')" \
                "$(jq -Rn --arg s "$url" '$s')" \
                "$code" \
                "$(jq -Rn --arg s "$via" '$s')" \
                "$( [[ $i -lt $total ]] && echo ',' )"
            done < /tmp/FEED_RESULTS
            echo '  ]'
            echo '}'
          } > status/feeds.json

      - name: Commit (if changes)
        id: commit
        shell: bash
        run: |
          set -euo pipefail
          email="${GIT_USER_EMAIL:-${GITHUB_ACTOR}@users.noreply.github.com}"
          git config user.name  "${GIT_USER_NAME}"
          git config user.email "${email}"
          git add status/feeds.json
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to commit."
          else
            git commit -m "chore(status): refresh feeds.json"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push (if committed)
        if: steps.commit.outputs.changed == 'true'
        run: |
          git push "https://x-access-token:${HF_PAT}@github.com/${{ github.repository }}.git" HEAD:main
