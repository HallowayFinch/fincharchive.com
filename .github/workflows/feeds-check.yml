name: Feeds Check & Publish

on:
  schedule:
    - cron: "*/30 * * * *" # every 30 minutes
  push:
    paths:
      - ".github/workflows/feeds-check.yml"
      - "status/feeds.json"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Probe feeds (friendly UA)
        id: probe
        run: |
          set -euo pipefail

          UA="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0 Safari/537.36"
          accept="application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.8"

          probe () {
            url="$1"
            code=$(curl -sS -L \
              -A "$UA" \
              -H "Accept: $accept" \
              --max-time 20 --retry 2 --retry-delay 1 \
              -o /dev/null -w "%{http_code}" \
              "$url" || true)
            printf '%s' "$code"
          }

          updated="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          all_rss_code="$(probe "https://fincharchive.com/feed/")"
          all_json_code="$(probe "https://fincharchive.com/feed.json")"
          logs_rss_code="$(probe "https://fincharchive.com/logs/feed.xml")"
          fn_rss_code="$(probe "https://fincharchive.com/field-notes/feed.xml")"
          substack_fn_code="$(probe "https://substack.com/api/v1/notes/rss?publication_id=6660929")"

          mkdir -p status
          cat > status/feeds.json <<JSON
{
  "updated_utc": "${updated}",
  "endpoints": [
    { "name": "ALL (RSS)",                 "url": "https://fincharchive.com/feed/",                   "status": ${all_rss_code} },
    { "name": "ALL (JSON)",                "url": "https://fincharchive.com/feed.json",               "status": ${all_json_code} },
    { "name": "Logs (RSS)",                "url": "https://fincharchive.com/logs/feed.xml",           "status": ${logs_rss_code} },
    { "name": "Field Notes (RSS)",         "url": "https://fincharchive.com/field-notes/feed.xml",    "status": ${fn_rss_code} },
    { "name": "Substack Field Notes (external)", "url": "https://substack.com/api/v1/notes/rss?publication_id=6660929", "status": ${substack_fn_code} }
  ]
}
JSON

      - name: Commit & push feeds.json (actor email)
        run: |
          set -e
          git config user.name  "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add status/feeds.json
          if ! git diff --cached --quiet; then
            git commit -m "chore(status): refresh feeds.json"
            git push
          else
            echo "No change in status/feeds.json"
          fi
