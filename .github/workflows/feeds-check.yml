name: Feeds Check & Publish

on:
  workflow_dispatch: {}
  schedule:
    - cron: "12 * * * *"

permissions:
  contents: write

concurrency:
  group: finch-feeds-check
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      SITE_BASE: "https://fincharchive.com"
      RSS_PROXY_URL: ${{ secrets.RSS_PROXY_URL }}
      UA: "FinchFeedsCheck (GitHub Actions; +https://fincharchive.com/status/)"
    steps:
      - name: Checkout (keep credentials)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Probe feeds and write /status/feeds.json (no heredocs)
        shell: bash
        run: |
          set -euo pipefail

          # Ensure jq is available (usually preinstalled on runners)
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

          url_encode () {
            python3 -c "import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1],safe=''))" "$1"
          }

          probe () {
            local url="$1"
            local http_code via="origin"

            http_code="$(curl -sS -L \
              -A "$UA" \
              -H "Accept: application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.1" \
              --max-time 20 --retry 2 --retry-delay 1 \
              -o /dev/null -w "%{http_code}" "$url" || true)"

            if [[ ( "$http_code" == "403" || "$http_code" == "000" ) && -n "${RSS_PROXY_URL:-}" ]]; then
              enc="$(url_encode "$url")"
              prox="${RSS_PROXY_URL}?url=${enc}"
              pcode="$(curl -sS -L \
                -A "$UA" \
                -H "Accept: application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.1" \
                --max-time 20 --retry 2 --retry-delay 1 \
                -o /dev/null -w "%{http_code}" "$prox" || true)"
              if [[ "$pcode" =~ ^[0-9]{3}$ && "$pcode" != "000" ]]; then
                http_code="$pcode"; via="proxy"
              fi
            fi

            printf '%s\t%s\n' "$http_code" "$via"
          }

          ALL_RSS="${SITE_BASE}/feed/"
          ALL_JSON="${SITE_BASE}/feed.json"
          LOGS_RSS="${SITE_BASE}/logs/feed.xml"
          NOTES_RSS="${SITE_BASE}/field-notes/feed.xml"
          SUBSTACK_FN="https://substack.com/api/v1/notes/rss?publication_id=6660929"

          # Build item JSON objects one per line into a temp file (avoids any heredoc usage)
          tmp="$(mktemp)"
          add_item () {
            local name="$1" url="$2"
            read -r code via < <(probe "$url")
            # Build one JSON object line using jq to ensure safe quoting
            jq -n --arg n "$name" --arg u "$url" --argjson s "${code:-0}" '{name:$n,url:$u,status:$s}' >> "$tmp"
          }

          add_item "ALL (RSS)"                         "$ALL_RSS"
          add_item "ALL (JSON)"                        "$ALL_JSON"
          add_item "Logs (RSS)"                        "$LOGS_RSS"
          add_item "Field Notes (RSS)"                 "$NOTES_RSS"
          add_item "Substack Field Notes (external)"   "$SUBSTACK_FN"

          updated="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          mkdir -p status

          # Slurp the per-line JSON objects as an array and wrap with the root object
          jq -n --arg u "$updated" --slurpfile e "$tmp" '{updated_utc:$u, endpoints:$e}' > status/feeds.json
          rm -f "$tmp"

      - name: Commit & push feeds.json (GITHUB_TOKEN)
        env:
          GIT_AUTHOR_NAME:       HallowayFinch
          GIT_AUTHOR_EMAIL:      ${{ github.actor }}@users.noreply.github.com
          GIT_COMMITTER_NAME:    HallowayFinch
          GIT_COMMITTER_EMAIL:   ${{ github.actor }}@users.noreply.github.com
        run: |
          set -e
          git add status/feeds.json
          if git diff --cached --quiet; then
            echo "No change in status/feeds.json"
          else
            git commit -m "chore(status): refresh feeds.json"
            git push
          fi
