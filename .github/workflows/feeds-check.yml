name: Feeds Check & Publish
# Finch Archive · Probe feeds and publish feed status
#
# Triggers:
# - Hourly at :12 UTC (staggered from other cron jobs)
# - Manual run via "Run workflow"
#
# Behavior:
# - Probes:
#     - /feed/ (RSS)
#     - /feed.json (JSONFeed)
#     - /logs/feed.xml
#     - /field-notes/feed.xml
#     - Substack Field Notes RSS
# - Uses RSS_PROXY_URL as a fallback for 403/000 responses
# - Writes status/feeds.json with endpoint statuses
# - Commits & pushes only when feeds.json changes

run-name: "Feeds Check & Publish • ${{ github.event_name }} #${{ github.run_number }}"

on:
  workflow_dispatch: {}
  schedule:
    # Stagger away from other jobs (:12 past the hour)
    - cron: "12 * * * *"

permissions:
  contents: write

# Queue feed checks per branch; never cancel in-flight runs.
concurrency:
  group: finch-feeds-check-${{ github.ref }}
  cancel-in-progress: false

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      SITE_BASE: "https://fincharchive.com"
      RSS_PROXY_URL: ${{ secrets.RSS_PROXY_URL }}
      UA: "FinchFeedsCheck (GitHub Actions; +https://fincharchive.com/status/)"
      GIT_AUTHOR_NAME: "HallowayFinch"
      GIT_AUTHOR_EMAIL: ${{ secrets.HF_NOREPLY_EMAIL }}
      HF_PAT: ${{ secrets.HF_PAT }}

    steps:
      - name: Checkout (keep history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Ensure jq present
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Probe feeds and write status/feeds.json
        shell: bash
        run: |
          set -euo pipefail

          url_encode () {
            python3 -c "import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1],safe=''))" "$1"
          }

          probe () {
            local url="$1" http_code via="origin"

            http_code="$(curl -sS -L \
              -A "$UA" \
              -H "Accept: application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.1" \
              --max-time 20 --retry 2 --retry-delay 1 \
              -o /dev/null -w "%{http_code}" "$url" || true)"

            # Fallback via proxy for 403/000 if configured
            if [[ ( "$http_code" == "403" || "$http_code" == "000" ) && -n "${RSS_PROXY_URL:-}" ]]; then
              enc="$(url_encode "$url")"
              prox="${RSS_PROXY_URL}?url=${enc}"

              pcode="$(curl -sS -L \
                -A "$UA" \
                -H "Accept: application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.1" \
                --max-time 20 --retry 2 --retry-delay 1 \
                -o /dev/null -w "%{http_code}" "$prox" || true)"

              if [[ "$pcode" =~ ^[0-9]{3}$ && "$pcode" != "000" ]]; then
                http_code="$pcode"
                via="proxy"
              fi
            fi

            printf '%s\t%s\n' "$http_code" "$via"
          }

          ALL_RSS="${SITE_BASE}/feed/"
          ALL_JSON="${SITE_BASE}/feed.json"
          LOGS_RSS="${SITE_BASE}/logs/feed.xml"
          NOTES_RSS="${SITE_BASE}/field-notes/feed.xml"
          SUBSTACK_FN="https://substack.com/api/v1/notes/rss?publication_id=6660929"

          tmp="$(mktemp)"

          add_item () {
            read -r code via < <(probe "$2")
            jq -n --arg n "$1" --arg u "$2" --argjson s "${code:-0}" \
              '{name:$n,url:$u,status:$s}' >> "$tmp"
          }

          add_item "ALL (RSS)"            "$ALL_RSS"
          add_item "ALL (JSON)"           "$ALL_JSON"
          add_item "Logs (RSS)"           "$LOGS_RSS"
          add_item "Field Notes (RSS)"    "$NOTES_RSS"
          add_item "Substack Field Notes" "$SUBSTACK_FN"

          updated="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          mkdir -p status

          jq -n --arg u "$updated" --slurpfile e "$tmp" \
            '{updated_utc:$u, endpoints:$e}' > status/feeds.json

          rm -f "$tmp"

      - name: Commit & safe push feeds.json (rebase + retry)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name  "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"

          git add status/feeds.json

          if git diff --cached --quiet; then
            echo "No change in status/feeds.json"
            exit 0
          fi

          git commit -m "chore(status): refresh feeds.json"

          git fetch origin main

          for n in 1 2 3; do
            git pull --rebase origin main || true

            if git push "https://x-access-token:${HF_PAT}@github.com/${{ github.repository }}.git" HEAD:main; then
              exit 0
            fi

            echo "Push attempt $n failed; retrying..."
            sleep 2
          done

          echo "Push failed after retries" >&2
          exit 1