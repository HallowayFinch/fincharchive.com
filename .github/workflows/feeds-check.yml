name: Feeds Check & Publish

on:
  schedule:
    - cron: "19 * * * *" # hourly, slightly offset from other jobs
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: finch-feeds-check
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      SITE_BASE: "https://fincharchive.com"
      RSS_PROXY_URL: ${{ secrets.RSS_PROXY_URL }} # optional; if set, we'll probe via proxy
      GIT_USER_NAME: "HallowayFinch"
      GIT_USER_EMAIL: ${{ secrets.HF_NOREPLY_EMAIL }}
      HF_PAT: ${{ secrets.HF_PAT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Probe feeds and write /status/feeds.json
        id: probe
        shell: bash
        run: |
          set -euo pipefail

          ua="FinchFeedsCheck/1.0 (+https://fincharchive.com/status/)"
          accept="application/rss+xml, application/atom+xml, application/xml;q=0.9, */*;q=0.8"

          # Helper: run curl and print only HTTP status code
          probe_raw() {
            local url="$1"
            curl -sS -L \
              -A "$ua" \
              -H "Accept: $accept" \
              --max-time 20 --retry 2 --retry-delay 1 \
              -o /dev/null -w "%{http_code}" \
              "$url" || echo "000"
          }

          # If a proxy is configured, wrap the target URL for probing.
          # Expected worker format:  ${RSS_PROXY_URL}?url=<encoded>
          probe() {
            local target="$1"
            if [[ -n "${RSS_PROXY_URL:-}" ]]; then
              local enc
              enc="$(python3 -c 'import sys,urllib.parse as u; print(u.quote(sys.argv[1], safe=""))' "$target")"
              probe_raw "${RSS_PROXY_URL}?url=${enc}"
            else
              probe_raw "$target"
            fi
          }

          ALL_RSS="${SITE_BASE}/feed/"
          ALL_JSON="${SITE_BASE}/feed.json"
          LOGS_RSS="${SITE_BASE}/logs/feed.xml"
          NOTES_RSS="${SITE_BASE}/field-notes/feed.xml"
          SUBSTACK_FN="https://substack.com/api/v1/notes/rss?publication_id=6660929"

          all_rss_code="$(probe "$ALL_RSS")"
          all_json_code="$(probe "$ALL_JSON")"
          logs_rss_code="$(probe "$LOGS_RSS")"
          fn_rss_code="$(probe "$NOTES_RSS")"
          substack_fn_code="$(probe "$SUBSTACK_FN")"

          updated_utc="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          mkdir -p status
          cat > status/feeds.json <<JSON
          {
            "updated_utc": "${updated_utc}",
            "endpoints": [
              { "name": "ALL (RSS)",                 "url": "${ALL_RSS}",     "status": ${all_rss_code} },
              { "name": "ALL (JSON)",                "url": "${ALL_JSON}",    "status": ${all_json_code} },
              { "name": "Logs (RSS)",                "url": "${LOGS_RSS}",   "status": ${logs_rss_code} },
              { "name": "Field Notes (RSS)",         "url": "${NOTES_RSS}",  "status": ${fn_rss_code} },
              { "name": "Substack Field Notes (external)", "url": "${SUBSTACK_FN}", "status": ${substack_fn_code} }
            ]
          }
          JSON

      - name: Commit (if changes)
        id: commit
        shell: bash
        run: |
          set -euo pipefail
          email="${GIT_USER_EMAIL:-${GITHUB_ACTOR}@users.noreply.github.com}"
          git config user.name  "${GIT_USER_NAME}"
          git config user.email "${email}"
          git add status/feeds.json
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to commit."
          else
            git commit -m "chore(status): refresh feeds.json"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push (if committed)
        if: steps.commit.outputs.changed == 'true'
        run: |
          git push "https://x-access-token:${HF_PAT}@github.com/${{ github.repository }}.git" HEAD:main