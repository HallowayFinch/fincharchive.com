name: Feeds Check & Publish

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch: {}
  push:
    paths:
      - ".github/workflows/feeds-check.yml"

permissions:
  contents: write

jobs:
  feeds:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve bases
        id: bases
        run: |
          REPO="${{ github.repository }}"
          OWNER="${REPO%%/*}"
          NAME="${REPO##*/}"

          # Preferred base: custom domain from CNAME
          if [[ -f CNAME && -s CNAME ]]; then
            CUSTOM="https://$(tr -d '[:space:]' < CNAME)"
          else
            CUSTOM=""
          fi

          # Fallback base: raw GitHub Pages origin
          ORIGIN="https://${OWNER}.github.io/${NAME}"

          echo "custom=${CUSTOM}" >> "$GITHUB_OUTPUT"
          echo "origin=${ORIGIN}" >> "$GITHUB_OUTPUT"

      - name: Build endpoint list
        id: endpoints
        run: |
          cat > /tmp/endpoints.json <<'JSON'
          [
            { "name": "All (RSS)",         "path": "/feed/",                "accept": "application/rss+xml"  },
            { "name": "All (JSON)",        "path": "/feed.json",            "accept": "application/json"     },
            { "name": "Logs (RSS)",        "path": "/logs/feed.xml",        "accept": "application/rss+xml"  },
            { "name": "Field Notes (RSS)", "path": "/field-notes/feed.xml", "accept": "application/rss+xml"  }
          ]
          JSON

      - name: Probe feeds (try custom → fallback to origin)
        run: |
          UA="FinchStatusBot/1.1 (+https://fincharchive.com/status/)"
          CUSTOM="${{ steps.bases.outputs.custom }}"
          ORIGIN="${{ steps.bases.outputs.origin }}"
          now="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          probe () {
            local url="$1" accept="$2"
            # HEAD first (some hosts block), then GET
            code=$(curl -sS -I -L -o /dev/null -w "%{http_code}" -A "$UA" -H "Accept: $accept" "$url" || echo 000)
            if [[ "$code" -eq 000 || "$code" -ge 400 ]]; then
              code=$(curl -sS -L -o /dev/null -w "%{http_code}" -A "$UA" -H "Accept: $accept" "$url" || echo 000)
            fi
            echo "$code"
          }

          jq -c '.[]' /tmp/endpoints.json | while read -r row; do
            name=$(jq -r '.name'  <<<"$row")
            path=$(jq -r '.path'  <<<"$row")
            accp=$(jq -r '.accept'<<<"$row")

            base_used=""
            status=000
            url_primary=""
            url_fallback=""

            if [[ -n "$CUSTOM" ]]; then
              url_primary="${CUSTOM}${path}"
              status=$(probe "$url_primary" "$accp")
              base_used="custom"
            fi

            if [[ "$status" -lt 200 || "$status" -ge 300 ]]; then
              url_fallback="${ORIGIN}${path}"
              status_fb=$(probe "$url_fallback" "$accp")
              if [[ "$status_fb" -ge 200 && "$status_fb" -lt 300 ]]; then
                status="$status_fb"
                base_used="origin"
              fi
            fi

            jq -n --arg n "$name" \
                  --arg p "$path" \
                  --arg s "$status" \
                  --arg b "$base_used" \
                  --arg u1 "$url_primary" \
                  --arg u2 "$url_fallback" \
              '{name:$n,path:$p,status:($s|tonumber),source:$b,primary:$u1,fallback:$u2}'
          done | jq -s --arg t "$now" '{updated_utc:$t,endpoints:.}' > /tmp/feeds.json

          mkdir -p status _data
          cp /tmp/feeds.json status/feeds.json
          cp /tmp/feeds.json _data/feeds-status.json

      - name: Commit results
        run: |
          if ! git diff --quiet -- status/feeds.json _data/feeds-status.json; then
            git config user.name  "HallowayFinch"
            git config user.email "${{ secrets.HF_NOREPLY_EMAIL }}"
            git add status/feeds.json _data/feeds-status.json
            git commit -m "chore(status): refresh feed checks (custom→origin fallback)"
            git push "https://x-access-token:${{ secrets.HF_PAT }}@github.com/${{ github.repository }}.git" HEAD:main
          else
            echo "No changes to commit."
          fi
