<!-- /_includes/head.html -->
{% comment %} Global head include for meta & previews {% endcomment %}

<!-- Finch Archive: prevent theme flash (set before paint) -->
<script>
(function () {
  try {
    var key   = 'fa-theme';
    var saved = localStorage.getItem(key);
    var theme = (saved === 'light' || saved === 'dark') ? saved : 'dark'; // default dark
    document.documentElement.setAttribute('data-theme', theme);
  } catch (e) { /* ignore */ }
})();
</script>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>{% if page.title %}{{ page.title }} · {% endif %}{{ site.title }}</title>
<meta name="description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">

{%- assign og_title = page.title | default: site.title -%}
{%- assign og_desc  = page.excerpt | default: site.description -%}
{%- assign og_url   = page.url | absolute_url -%}
{%- assign og_img   = page.og_image | default: '/assets/og/og-default.png' | absolute_url -%}

<link rel="canonical" href="{% if page.canonical_url %}{{ page.canonical_url }}{% else %}{{ og_url }}{% endif %}"/>

<!-- Open Graph / Twitter -->
<meta property="og:type" content="article">
<meta property="og:title" content="{{ og_title }}">
<meta property="og:description" content="{{ og_desc | strip_html | strip_newlines }}">
<meta property="og:url" content="{{ og_url }}">
<meta property="og:image" content="{{ og_img }}">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ og_title }}">
<meta name="twitter:description" content="{{ og_desc | strip_html | strip_newlines }}">
<meta name="twitter:image" content="{{ og_img }}">

<!-- Feeds -->
<link rel="alternate" type="application/rss+xml" title="{{ site.title }} — Logs" href="{{ '/logs.xml' | absolute_url }}">
<link rel="alternate" type="application/rss+xml" title="{{ site.title }} — Field Notes" href="{{ '/field-notes/feed.xml' | absolute_url }}">
<link rel="alternate" type="application/feed+json" title="{{ site.title }} — JSON Feed" href="{{ '/feed.json' | absolute_url }}">

<!-- Browser UI tint -->
<meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#000000">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#f6f2e7">
<meta name="color-scheme" content="dark light">

{%- comment -%}
Preload homepage featured image (newest log’s hero) to speed LCP.
{%- endcomment -%}
{%- if page.url == "/" -%}
  {%- assign feat = site.logs | sort: "date" | reverse | first -%}
  {%- if feat and feat.hero_image -%}
    <link rel="preload" as="image" href="{{ feat.hero_image | relative_url }}">
  {%- endif -%}
{%- endif -%}

{%- comment -%} Structured data {%- endcomment -%}
{% include seo.html %}

{%- comment -%}
Rel prev/next for single entries (Logs and Field Notes).
Sorted ascending by date so:
- prev  = earlier entry
- next  = later entry
Links are emitted only when neighbors exist.
{%- endcomment -%}
{%- assign coll = nil -%}
{%- if page.collection == 'logs' -%}
  {%- assign coll = site.logs | sort: 'date' -%}
{%- elsif page.collection == 'field-notes' -%}
  {%- assign coll = site["field-notes"] | sort: 'date' -%}
{%- endif -%}

{%- if coll and coll.size > 0 -%}
  {%- assign idx = nil -%}
  {%- for doc in coll -%}
    {%- if doc.url == page.url -%}{%- assign idx = forloop.index0 -%}{%- break -%}{%- endif -%}
  {%- endfor -%}
  {%- if idx != nil -%}
    {%- assign prev_idx = idx | minus: 1 -%}
    {%- assign next_idx = idx | plus: 1 -%}
    {%- if prev_idx >= 0 -%}
      <link rel="prev" href="{{ coll[prev_idx].url | absolute_url }}">
    {%- endif -%}
    {%- if next_idx < coll.size -%}
      <link rel="next" href="{{ coll[next_idx].url | absolute_url }}">
    {%- endif -%}
  {%- endif -%}
{%- endif -%}