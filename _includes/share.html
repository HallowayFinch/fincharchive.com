<!-- /_includes/share.html -->
{% comment %}
Renders:
- Optional "Source" (with icon) if page.source_url is present
- Share button (Web Share API + clipboard fallback)
- Auto-prepends a centered dot separator
- Custom tooltip on hover/focus, hides instantly on click
- "Copied ✓" micro-animation + a11y live announcement
{% endcomment %}

<span class="meta-actions">
  <span aria-hidden="true">·</span>

  {%- if page.source_url -%}
    <a class="meta-link" href="{{ page.source_url }}" target="_blank" rel="noopener">
      Source
      <svg class="icon" aria-hidden="true"><use href="#icon-external"/></svg>
      <span class="visually-hidden">(opens in new tab)</span>
    </a>
    <span aria-hidden="true">·</span>
  {%- endif -%}

  <button class="share-inline" type="button" id="share-btn" aria-label="Share this page">
    <svg class="icon" aria-hidden="true"><use href="#icon-share"/></svg>
    <span class="tooltip" role="tooltip">Share this page</span>
  </button>

  <!-- SR-only live region for copy confirmation -->
  <span id="share-live" class="visually-hidden" aria-live="polite"></span>
</span>

<script>
(function () {
  var btn  = document.getElementById('share-btn');
  if (!btn) return;

  var title = (document.querySelector('h1') && document.querySelector('h1').textContent.trim()) || document.title;
  var url   = window.location.href;
  var live  = document.getElementById('share-live');

  function flashCopied() {
    var oldHTML = btn.innerHTML;
    btn.classList.add('is-copied');
    btn.setAttribute('aria-label', 'Link copied');
    if (live) live.textContent = 'Link copied to clipboard';

    btn.innerHTML = '✓';
    setTimeout(function () {
      btn.innerHTML = oldHTML;
      btn.classList.remove('is-copied');
      btn.setAttribute('aria-label', 'Share this page');
      if (live) live.textContent = '';
    }, 1200);
  }

  // Hide tooltip immediately on click (prevents overlap with ✓)
  btn.addEventListener('mousedown', function () { btn.classList.add('tooltip-hide'); });
  btn.addEventListener('mouseup',   function () { btn.classList.remove('tooltip-hide'); });
  btn.addEventListener('keyup',     function (e) {
    if (e.key === 'Enter' || e.key === ' ') btn.classList.add('tooltip-hide');
  });
  btn.addEventListener('blur', function () { btn.classList.remove('tooltip-hide'); }, true);

  btn.addEventListener('click', async function () {
    try {
      if (navigator.share) {
        await navigator.share({ title: title, url: url });
        // No reliable "success" signal from share sheet; skip ✓ here.
      } else if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(url);
        flashCopied();
      } else {
        prompt('Copy this link:', url);
      }
    } catch (e) {
      // User canceled or blocked; no-op
    }
  });
})();
</script>

<style>
.meta-actions { display:inline-flex; gap:.45rem; align-items:center; }
.meta-link    { display:inline-flex; gap:.35rem; align-items:center; }

/* Share button */
.share-inline{
  position:relative;
  display:inline-flex; align-items:center; justify-content:center;
  width:26px; height:26px; line-height:1;
  margin:-3px 0 -3px 2px;
  border:1px solid var(--badge-border); border-radius:6px;
  background:var(--badge-bg); color:var(--fg);
  vertical-align:middle; cursor:pointer;
  opacity:.85;
  transition:opacity .15s ease, transform .08s ease, border-color .15s ease, box-shadow .15s ease;
}
.share-inline:hover,
.share-inline:focus-visible{
  opacity:1; transform:translateY(-1px); border-color:var(--accent);
}
.share-inline .icon{ width:15px; height:15px; }

/* Tooltip */
.tooltip{
  position:absolute;
  bottom:calc(100% + 6px);
  left:50%;
  transform:translateX(-50%) scale(.95);
  background:var(--badge-bg);
  color:var(--fg);
  font-size:.75rem;
  padding:.25rem .5rem;
  border:1px solid var(--badge-border);
  border-radius:4px;
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
  transition:opacity .2s ease, transform .2s ease;
  z-index:100;
}
.tooltip::after{
  content:"";
  position:absolute;
  top:100%; left:50%; transform:translateX(-50%);
  border:5px solid transparent;
  border-top-color:var(--badge-bg);
  opacity:.9;
}
.share-inline:hover .tooltip,
.share-inline:focus-visible .tooltip{
  opacity:1;
  transform:translateX(-50%) scale(1);
}
/* Hide tooltip instantly during activation */
.tooltip-hide .tooltip{
  opacity:0 !important;
  transform:translateX(-50%) scale(.95) !important;
}

/* Copied ✓ animation */
@keyframes fa-pop {
  0%   { transform:scale(0.92); opacity:.0; }
  40%  { transform:scale(1.04); opacity:1; }
  100% { transform:scale(1);    opacity:1; }
}
@keyframes fa-glow {
  0%   { box-shadow:0 0 0 0 rgba(122,58,58,.0); }
  35%  { box-shadow:0 0 0 4px rgba(122,58,58,.18); }
  100% { box-shadow:0 0 0 0 rgba(122,58,58,.0); }
}
.share-inline.is-copied{
  border-color:var(--accent);
  animation:fa-glow 900ms ease-out;
}
.share-inline.is-copied,
.share-inline.is-copied>*{
  animation:fa-pop 220ms cubic-bezier(.2,.8,.3,1) forwards;
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .tooltip,
  .share-inline,
  .share-inline>*{ transition:none !important; animation:none !important; }
}
</style>